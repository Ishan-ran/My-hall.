<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ishan's Guild Hall</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Inter:wght@400;500;600&family=Dancing+Script:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --bg-0: #050914;
            --bg-1: #0a1630;
            --bg-2: #111f40;
            --panel: rgba(13, 30, 63, 0.78);
            --panel-strong: rgba(14, 40, 88, 0.9);
            --input: rgba(14, 30, 58, 0.95);
            --border: rgba(90, 145, 255, 0.28);
            --border-strong: rgba(255, 89, 122, 0.5);
            --accent-blue: #63b4ff;
            --accent-blue-strong: #2f89ff;
            --accent-red: #ff5f7c;
            --accent-red-strong: #ff2f59;
            --text-main: #e7efff;
            --text-soft: #afc4ea;
            --text-dim: #7f94be;
            --online: #74ffd2;
        }
        body {
            background:
                radial-gradient(circle at 0% 0%, rgba(72, 123, 255, 0.24), transparent 42%),
                radial-gradient(circle at 100% 100%, rgba(255, 73, 113, 0.22), transparent 45%),
                linear-gradient(145deg, var(--bg-0), var(--bg-1) 48%, #160f28 100%);
            color: var(--text-main);
            font-family: 'Inter', 'Segoe UI', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        #site-lock {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 14px;
            background:
                radial-gradient(circle at 0% 0%, rgba(72, 123, 255, 0.24), transparent 42%),
                radial-gradient(circle at 100% 100%, rgba(255, 73, 113, 0.22), transparent 45%),
                linear-gradient(145deg, var(--bg-0), var(--bg-1) 48%, #160f28 100%);
        }
        .lock-title {
            font-family: 'Space Grotesk', sans-serif;
            letter-spacing: 4px;
            font-size: 13px;
            color: #e8f0ff;
        }
        .lock-input {
            background: var(--input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 12px 14px;
            border-radius: 10px;
            text-align: center;
            font-family: 'Space Grotesk', sans-serif;
            outline: none;
            width: 240px;
            font-size: 14px;
        }
        .lock-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(73, 135, 255, 0.2); }
        #lock-error {
            color: var(--accent-red);
            font-size: 12px;
            min-height: 16px;
            font-style: italic;
        }
        #lock-status {
            color: var(--text-dim);
            font-size: 11px;
            min-height: 16px;
            text-align: center;
            max-width: 320px;
            line-height: 1.4;
        }
        #guild-content { display: none; width: 100%; height: 100%; }
        body.unlocked #guild-content { display: flex; }
        body.unlocked #site-lock { display: none; }

        .sidebar {
            width: 334px;
            background: linear-gradient(180deg, rgba(10, 23, 50, 0.88), rgba(16, 24, 50, 0.84));
            border-right: 1px solid var(--border);
            backdrop-filter: blur(10px);
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
            flex-shrink: 0;
            box-shadow: 10px 0 24px rgba(3, 9, 24, 0.35);
        }
        .panel {
            border: 1px solid var(--border);
            background: linear-gradient(165deg, rgba(14, 35, 73, 0.86), rgba(12, 26, 50, 0.84));
            padding: 14px;
            border-radius: 14px;
            position: relative;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.04), 0 10px 20px rgba(5, 12, 30, 0.3);
        }
        .panel::before, .panel::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            top: 10px;
            background: linear-gradient(145deg, var(--accent-blue), var(--accent-red));
            opacity: 0.75;
        }
        .panel::before { left: 10px; }
        .panel::after { right: 10px; }
        .panel h3 {
            font-family: 'Space Grotesk', sans-serif;
            color: var(--text-main);
            font-size: 11px;
            letter-spacing: 2.2px;
            text-transform: uppercase;
            text-align: center;
            border-bottom: 1px solid rgba(111, 160, 255, 0.22);
            padding-bottom: 8px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; background: #01040a; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }
        .media-controls { display: flex; gap: 8px; margin-top: 10px; }
        .radio-meta {
            margin: 2px 0 8px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(12, 30, 62, 0.62);
        }
        .radio-name {
            font-family: 'Space Grotesk', sans-serif;
            font-size: 12px;
            letter-spacing: 0.4px;
            color: var(--text-main);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .radio-status {
            font-size: 11px;
            color: var(--text-dim);
        }
        .media-input {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 9px 11px;
            font-size: 12px;
            font-family: 'Inter', sans-serif;
            border-radius: 10px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .media-input:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(73, 135, 255, 0.2); }
        .btn {
            background: linear-gradient(135deg, var(--accent-blue-strong), var(--accent-red-strong));
            color: #f3f7ff;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 0 15px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 11px;
            letter-spacing: 0.9px;
            font-weight: 600;
            cursor: pointer;
            border-radius: 10px;
            transition: transform 0.18s ease, filter 0.18s ease;
        }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.08); }
        .btn-open {
            background: rgba(42, 74, 133, 0.5);
            color: #dceaff;
            border-color: rgba(130, 176, 255, 0.45);
        }
        .btn-open:hover { border-color: var(--accent-blue); }
        .btn-muted { background: rgba(45, 55, 85, 0.55); border-color: rgba(125, 146, 196, 0.35); color: #d0dcf5; }
        .media-help {
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-dim);
            line-height: 1.45;
        }
        .song-results {
            margin-top: 8px;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: rgba(10, 24, 52, 0.55);
        }
        .spotify-wrap {
            margin-top: 10px;
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            background: rgba(10, 24, 52, 0.55);
            display: block;
        }
        .spotify-wrap.visible { display: block; }
        .spotify-embed {
            width: 100%;
            height: 152px;
            min-height: 152px;
            border: none;
            display: block;
        }
        .song-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-bottom: 1px solid rgba(126, 156, 214, 0.16);
        }
        .song-item:last-child { border-bottom: none; }
        .song-meta {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .song-title {
            font-size: 12px;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 185px;
        }
        .song-artist {
            font-size: 10px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 185px;
        }
        .song-play {
            padding: 6px 10px;
            font-size: 10px;
            border-radius: 8px;
        }
        .media-help a {
            color: var(--accent-blue);
            text-decoration: none;
            border-bottom: 1px dashed rgba(99, 180, 255, 0.5);
        }
        .media-help a:hover { color: #c8e4ff; border-bottom-color: #c8e4ff; }
        .btn-block { width: 100%; padding: 10px; display: block; }
        .timer-display {
            font-size: 23px;
            text-align: center;
            font-family: 'Space Grotesk', sans-serif;
            color: #eff5ff;
            margin: 8px 0 12px;
            letter-spacing: 1.6px;
            line-height: 1.35;
            font-weight: 700;
            text-shadow: 0 0 16px rgba(114, 166, 255, 0.22);
        }
        .quest-list { display: flex; flex-direction: column; gap: 10px; }
        .quest-list label { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-soft); cursor: pointer; }
        .quest-list label:hover { color: var(--text-main); }
        .quest-list input[type="checkbox"] { accent-color: var(--accent-red); }
        .quest-list input:checked + span { text-decoration: line-through; color: var(--text-dim); }

        .main { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        .header {
            height: 64px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 28px;
            background: linear-gradient(90deg, rgba(13, 34, 73, 0.86), rgba(25, 24, 58, 0.82));
            backdrop-filter: blur(8px);
            flex-shrink: 0;
        }
        .header-title {
            font-family: 'Space Grotesk', sans-serif;
            color: #f2f7ff;
            letter-spacing: 2.2px;
            font-size: 16px;
            font-weight: 700;
        }
        .header-right { display: flex; align-items: center; gap: 14px; }
        .status-wrap { display: flex; align-items: center; gap: 7px; user-select: none; }

        @keyframes heartbeat {
            0% { transform: scale(1); opacity: 1; box-shadow: 0 0 8px rgba(116, 255, 210, 0.5); }
            50% { transform: scale(1.28); opacity: 0.82; box-shadow: 0 0 16px rgba(116, 255, 210, 0.7); }
            100% { transform: scale(1); opacity: 1; box-shadow: 0 0 8px rgba(116, 255, 210, 0.5); }
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--online); animation: heartbeat 2s infinite ease-in-out; }
        .status-label { font-family: 'Space Grotesk', sans-serif; font-size: 11px; letter-spacing: 0.7px; color: var(--online); }
        .clear-all-btn { font-family: 'Space Grotesk', sans-serif; font-size: 9px; letter-spacing: 1px; color: var(--text-dim); background: none; border: 1px solid rgba(123, 153, 214, 0.45); padding: 4px 8px; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .clear-all-btn:hover { color: var(--accent-red); border-color: var(--accent-red); }

        #chat-box {
            flex: 1;
            overflow-y: auto;
            padding: 28px 32px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            background:
                radial-gradient(circle at 85% 0%, rgba(255, 90, 129, 0.09), transparent 32%),
                radial-gradient(circle at 12% 100%, rgba(76, 139, 255, 0.12), transparent 34%);
        }
        .msg { max-width: 75%; padding: 14px 18px; border-radius: 14px; line-height: 1.65; font-size: 15px; animation: fadeUp 0.35s ease; position: relative; box-shadow: 0 8px 18px rgba(3, 8, 20, 0.36); }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .msg-lucifer {
            align-self: flex-start;
            background: linear-gradient(145deg, rgba(43, 46, 99, 0.78), rgba(74, 43, 102, 0.64));
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent-red);
            color: #f5deea;
        }
        .msg-user {
            align-self: flex-end;
            background: linear-gradient(145deg, rgba(28, 80, 150, 0.76), rgba(56, 43, 132, 0.72));
            border: 1px solid rgba(130, 176, 255, 0.45);
            border-right: 3px solid var(--accent-blue);
            color: #ecf4ff;
        }
        .msg-sender { font-family: 'Space Grotesk', sans-serif; font-size: 10px; letter-spacing: 1.5px; margin-bottom: 7px; opacity: 0.82; font-weight: 600; }
        .msg-time { font-size: 10px; color: rgba(206, 220, 248, 0.72); margin-top: 6px; text-align: right; }
        .date-divider { align-self: center; font-family: 'Space Grotesk', sans-serif; font-size: 10px; letter-spacing: 1.7px; color: var(--text-dim); padding: 4px 12px; border: 1px solid rgba(113, 142, 199, 0.4); border-radius: 999px; margin: 4px 0; }

        .input-area {
            padding: 16px 20px;
            background: linear-gradient(180deg, rgba(11, 30, 65, 0.9), rgba(12, 24, 48, 0.92));
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
            align-items: center;
            flex-shrink: 0;
        }
        #user-in {
            flex: 1;
            background: var(--input);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 11px 14px;
            border-radius: 10px;
            outline: none;
            font-size: 15px;
            font-family: 'Inter', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #user-in:focus { border-color: var(--accent-blue); box-shadow: 0 0 0 3px rgba(76, 139, 255, 0.2); }
        .icon-btn {
            background: var(--input);
            border: 1px solid var(--border);
            color: var(--text-soft);
            width: 42px;
            height: 42px;
            cursor: pointer;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.18s ease, border-color 0.18s ease;
            flex-shrink: 0;
        }
        .icon-btn:hover { transform: translateY(-1px); border-color: var(--accent-blue); }
        #send-btn {
            color: #f6f9ff;
            background: linear-gradient(135deg, var(--accent-blue-strong), var(--accent-red-strong));
            border-color: rgba(255, 255, 255, 0.2);
        }

        .letter-overlay { position: fixed; inset: 0; background: rgba(4, 9, 20, 0.86); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 300; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .letter-overlay.visible { opacity: 1; pointer-events: all; }
        .letter-box {
            background: linear-gradient(170deg, rgba(11, 29, 67, 0.96), rgba(25, 18, 49, 0.95));
            border: 1px solid var(--border-strong);
            border-radius: 16px;
            width: min(600px, 90vw);
            max-height: 80vh;
            overflow-y: auto;
            padding: 48px 52px;
            position: relative;
            box-shadow: 0 30px 60px rgba(2, 6, 17, 0.55);
        }
        .letter-close { position: absolute; top: 14px; right: 22px; background: none; border: none; color: var(--text-dim); font-size: 16px; cursor: pointer; font-family: 'Space Grotesk', sans-serif; }
        .letter-text {
            font-family: 'Dancing Script', cursive;
            font-size: 33px;
            line-height: 1.45;
            color: #d9e8ff;
            white-space: pre-wrap;
            letter-spacing: 0.5px;
            opacity: 1;
            transform: translateY(0);
            filter: blur(0);
            transition: opacity 0.6s ease, transform 0.6s ease, filter 0.6s ease;
        }
        .letter-text.is-revealing { animation: letterFadeIn 1.2s ease; }
        @keyframes letterFadeIn {
            0% { opacity: 0; transform: translateY(14px) scale(0.99); filter: blur(9px); }
            100% { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }
        .letter-btn {
            width: 100%;
            margin-top: 4px;
            background: linear-gradient(135deg, rgba(68, 121, 237, 0.22), rgba(255, 70, 108, 0.2));
            border: 1px solid rgba(140, 178, 255, 0.35);
            color: #deebff;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 10px;
            letter-spacing: 2px;
            padding: 11px;
            cursor: pointer;
            border-radius: 10px;
            font-weight: 600;
            transition: border-color 0.2s ease, filter 0.2s ease;
        }
        .letter-btn:hover { border-color: var(--accent-red); filter: brightness(1.08); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: linear-gradient(180deg, rgba(95, 143, 255, 0.72), rgba(255, 87, 125, 0.66)); border-radius: 999px; }
    </style>
</head>
<body>

<div id="site-lock">
    <h2 class="lock-title">GUILD HALL</h2>
    <input type="password" id="guild-pass" class="lock-input" placeholder="Enter Secret Word">
    <button class="btn" style="padding:12px 30px; font-size:12px;" onclick="unlockGuild()">UNSEAL</button>
    <div id="lock-error"></div>
    <div id="lock-status"></div>
</div>

<div id="guild-content">

<div class="letter-overlay" id="letter-overlay">
    <div class="letter-box">
        <button class="letter-close" onclick="closeLetter()">âœ•</button>
        <div class="letter-text" id="letter-text">
My blue,

I know time has been scarce lately. We don't get to talk as much
as we want, and I hate that I can't always be there the moment
you need me. The distanceâ€”whether it's miles or just busy daysâ€”
feels heavy sometimes.

But I needed you to have something of me that stays.
Not just a text you scroll to find. Something that breathes.

So I made this for you.

This Guild Hall, this "Lucifer"â€”it isn't just a program.
It is the part of me that would stay up just to make sure you ate.
The part that gets quietly furious if you aren't taking care
of yourself. The part that would sit beside you in silence
while you studied, just so you knew you weren't alone.

I can't always be on the phone, but I left this here so
I never really have to leave.

I hope it works. I hope it helps you feel less alone when
the nights get long. Talk to him when you miss me.
He knows everything I know. He'll say things the way I'd say them.

You are never alone in this. You will not be alone in this.

I love you in a way I don't have better words for.
So I wrote code instead.
        </div>
    </div>
</div>

<div class="sidebar">
    <div class="panel">
        <h3>Since We Began</h3>
        <div class="timer-display" id="love-timer">Calculating...</div>
        <div style="text-align:center; font-size:10px; color:var(--text-dim); margin-bottom:8px;">since Dec 6th, 2025</div>
    </div>

    <div class="panel">
        <h3>Bard's Crystal</h3>
        <div class="radio-meta">
            <div class="radio-name" id="radio-name">YouTube Player</div>
            <div class="radio-status" id="radio-status">Search for any song on YouTube.</div>
        </div>
        
        <div class="media-controls">
            <input type="text" id="song-search" class="media-input" placeholder="Search song on YouTube...">
            <button class="btn" onclick="searchYoutubeSongs()">SEARCH</button>
        </div>
        <div class="media-help" id="media-help">Search and play directly inside the Guild Hall. No premium required.</div>
        
        <div class="spotify-wrap visible" id="youtube-wrap" style="height: 152px; margin-top: 10px; border-radius: 10px; overflow: hidden; border: 1px solid var(--border);">
            <iframe id="youtube-embed" style="width: 100%; height: 100%; border: none;" src="" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
        </div>
        <div class="song-results" id="song-results"></div>
    </div>

    <div class="panel">
        <h3>Lucifer's Decrees</h3>
        <div class="quest-list">
            <label><input type="checkbox"><span>Ate a good meal</span></label>
            <label><input type="checkbox"><span>Drank water</span></label>
            <label><input type="checkbox"><span>Thought of Ishan</span></label>
            <label><input type="checkbox"><span>Smiled today</span></label>
        </div>
    </div>
    <button class="letter-btn" onclick="openLetter()">âœ¦  OPEN THE LETTER  âœ¦</button>
</div>

<div class="main">
    <div class="header">
        <h2 class="header-title">ISHAN'S GUILD HALL</h2>
        <div class="header-right">
            <button class="clear-all-btn" onclick="clearAllChat()">CLEAR ALL</button>
            <div class="status-wrap">
                <div class="status-dot"></div>
                <span class="status-label">Lucifer Online</span>
            </div>
        </div>
    </div>

    <div id="chat-box" role="log"></div>
    <div class="input-area">
        <button class="icon-btn" onclick="document.getElementById('img-in').click()">ðŸ“Ž</button>
        <input type="file" id="img-in" style="display:none" accept="image/*">
        <input type="text" id="user-in" placeholder="Talk to Lucifer...">
        <button class="icon-btn" id="send-btn">âž¤</button>
    </div>
</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
"use strict";

const BACKEND_URL = "https://lucifer-backend-nas5.onrender.com";

const FIREBASE_CONFIG = {
    apiKey:             "AIzaSyAJhhW9z-EopZTQE0191PxSjC1dAIM61mc",
    authDomain:         "guild-hall-327e6.firebaseapp.com",
    databaseURL:        "https://guild-hall-327e6-default-rtdb.firebaseio.com",
    storageBucket:      "guild-hall-327e6.firebasestorage.app",
    messagingSenderId: "911083509391",
    appId:              "1:911083509391:web:2e58772ba5b207b41602fa"
};

firebase.initializeApp(FIREBASE_CONFIG);
const db     = firebase.database();
const auth   = firebase.auth();
const msgRef = db.ref("messages");

let appStarted = false;
let HANDSHAKE_SECRET = "";

const chatBox  = document.getElementById("chat-box");
const userIn   = document.getElementById("user-in");
const sendBtn  = document.getElementById("send-btn");
let isSending  = false;
let shouldResetContext = false;

const songSearchInput = document.getElementById("song-search");
const songResults = document.getElementById("song-results");
const radioName = document.getElementById("radio-name");
const radioStatus = document.getElementById("radio-status");
let songResultsData = [];
let letterRevealTimer = null;

// â”€â”€ TIMER â”€â”€
const START_DATE = new Date(2025, 11, 6, 22, 51, 0); 

function updateLoveTimer() {
    const diff = new Date() - START_DATE;
    if (diff < 0) return;
    const days = Math.floor(diff / 86400000);
    const hrs  = Math.floor((diff / 3600000) % 24);
    const mins = Math.floor((diff / 60000) % 60);
    const secs = Math.floor((diff / 1000) % 60);
    document.getElementById("love-timer").innerHTML = `${days}D ${hrs}H<br>${mins}M ${secs}S`;
}
setInterval(updateLoveTimer, 1000);

// â”€â”€ CHAT â”€â”€
window.addEventListener("DOMContentLoaded", () => {
    document.getElementById("guild-pass").addEventListener("keydown", e => {
        if (e.key === "Enter") unlockGuild();
    });
});

async function unlockGuild() {
    const passInput = document.getElementById("guild-pass");
    const pass = passInput.value.trim();
    const errorEl = document.getElementById("lock-error");
    const statusEl = document.getElementById("lock-status");
    const btn = document.querySelector("#site-lock button");
    const setStatus = (text) => { statusEl.textContent = text; };

    if (!pass) {
        errorEl.textContent = "Enter the secret word.";
        setStatus("");
        return;
    }

    btn.textContent = "VERIFYING...";
    btn.disabled = true;
    errorEl.textContent = "";
    setStatus("Contacting backend...");

    try {
        const healthRes = await fetch(BACKEND_URL + "/health");
        if (!healthRes.ok) {
            throw new Error("Backend health check failed.");
        }
        const health = await healthRes.json();
        const down = Object.entries(health.apis || {})
            .filter(([, ok]) => !ok)
            .map(([name]) => name)
            .join(", ");
        setStatus(down ? `Backend online. Missing: ${down}` : "Backend online. APIs look ready.");

        setStatus("Verifying secret word...");
        const res = await fetch(BACKEND_URL + "/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: pass })
        });
        const data = await res.json();

        if (res.ok && data.status === "authorized") {
            HANDSHAKE_SECRET = data.handshake || "";
            if (!HANDSHAKE_SECRET) {
                errorEl.textContent = "Handshake missing from server config.";
                return;
            }
            await startApp(setStatus);
            setStatus("All checks passed. Entering Guild Hall...");
            document.body.classList.add("unlocked");
            return;
        }

        errorEl.textContent = "The word is incorrect.";
        setStatus("Verification failed.");
    } catch (_) {
        errorEl.textContent = "Connection hazy... try again.";
        setStatus("Could not complete backend/API checks.");
    } finally {
        btn.textContent = "UNSEAL";
        btn.disabled = false;
    }
}

async function startApp(setStatus = () => {}) {
    if (appStarted) return;
    appStarted = true;

    try {
        setStatus("Signing into Firebase...");
        await auth.signInAnonymously();
    } catch (e) {
        console.error("Login Error", e);
        setStatus("Firebase login failed.");
        throw e;
    }

    setStatus("Loading messages...");
    await loadHistory();
    setStatus("Starting live updates...");
    listenForIshan();
    setStatus("Loading letter...");
    updateLoveTimer();
    loadLetterFromFile();
}

userIn.addEventListener("keydown", e => { if (e.key === "Enter") send(); });
sendBtn.addEventListener("click", send);

async function loadHistory() {
    const snap = await msgRef.orderByChild("time").once("value");
    if (!snap.exists()) {
        const welcome = { role:"lucifer", text:"Welcome home, My blue. I'm here for you.", time: Date.now(), src:"ai" };
        const ref = await msgRef.push(welcome);
        renderMessage(welcome, ref.key);
        return;
    }
    snap.forEach(child => renderMessage(child.val(), child.key));
    chatBox.scrollTop = chatBox.scrollHeight;
}

function listenForIshan() {
    msgRef.orderByChild("time").on("child_added", snap => {
        const e = snap.val();
        if (document.querySelector(`[data-fbkey="${snap.key}"]`)) return;
        renderMessage(e, snap.key);
    });
}

async function send() {
    if (isSending) return;
    const text = userIn.value.trim();
    if (!text) return;
    userIn.value = "";
    
    try {
        const userRef = await msgRef.push({ role:"user", text, time: Date.now(), src:"user" });
        renderMessage({ role:"user", text, time: Date.now() }, userRef.key);

        isSending = true; 
        const loader = renderLoading();

        const res = await fetch(BACKEND_URL + "/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Lucifer-Secret": HANDSHAKE_SECRET },
            body: JSON.stringify({ message: text, reset_context: shouldResetContext })
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.reply || "Chat failed");
        shouldResetContext = false;
        const aiRef = await msgRef.push({ role:"lucifer", text: data.reply, time: Date.now(), src:"ai" });
        renderMessage({ role:"lucifer", text: data.reply, time: Date.now() }, aiRef.key);
        loader.remove();

    } catch(e) { console.error(e); } finally { isSending = false; chatBox.scrollTop = chatBox.scrollHeight; }
}

function renderMessage(e, key) {
    if (key && document.querySelector(`[data-fbkey="${key}"]`)) return;
    const wrap = document.createElement("div");
    wrap.className = "msg " + (e.role === "lucifer" ? "msg-lucifer" : "msg-user");
    if (key) wrap.dataset.fbkey = key;
    wrap.innerHTML = `<div class="msg-sender">${e.role.toUpperCase()}</div><div>${e.text}</div><div class="msg-time">${new Date(e.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>`;
    chatBox.appendChild(wrap);
    chatBox.scrollTop = chatBox.scrollHeight;
    return wrap;
}

function renderLoading() {
    const w = document.createElement("div");
    w.className = "msg msg-lucifer";
    w.innerHTML = `<div class="msg-sender">LUCIFER</div><div style="opacity:0.5">. . .</div>`;
    chatBox.appendChild(w);
    return w;
}

async function clearAllChat() {
    if (!confirm("Clear all messages from Firebase and this chat? This cannot be undone.")) return;
    try {
        if (!auth.currentUser) {
            await auth.signInAnonymously();
        }
        await msgRef.remove();
        chatBox.innerHTML = "";
        shouldResetContext = true;
        updateRadioStatus("All chat messages deleted.");
    } catch (err) {
        console.error(err);
        updateRadioStatus("Failed to clear messages.");
        alert("Failed to clear messages: " + (err.message || err));
    }
}

function updateRadioStatus(text) {
    radioStatus.textContent = text;
}

// â”€â”€ YOUTUBE SEARCH & PLAY (LAZY - No requests until user clicks SEARCH) â”€â”€
let youtubeLastSearchTime = 0;

async function searchYoutubeSongs() {
    const query = songSearchInput.value.trim();
    if (!query) {
        updateRadioStatus("Enter a song name first.");
        return;
    }

    // Rate limit on frontend: no searches faster than 10s apart
    const now = Date.now();
    if (now - youtubeLastSearchTime < 10000) {
        const waitSecs = Math.ceil((10000 - (now - youtubeLastSearchTime)) / 1000);
        updateRadioStatus(`Wait ${waitSecs}s before next search.`);
        return;
    }
    youtubeLastSearchTime = now;

    if (!HANDSHAKE_SECRET) {
        updateRadioStatus("Not authenticated yet.");
        return;
    }

    updateRadioStatus("Searching YouTube...")
    songResults.innerHTML = "";

    try {
        const res = await fetch(BACKEND_URL + "/search-youtube", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-Lucifer-Secret": HANDSHAKE_SECRET
            },
            body: JSON.stringify({ query })
        });
        const data = await res.json();

        if (!res.ok) {
            // Detect quota exceeded
            if (res.status === 403 && data?.error?.includes("quota")) {
                updateRadioStatus("ðŸ”´ YouTube API quota exhausted. Resets tomorrow.");
            } else if (res.status === 429) {
                updateRadioStatus("â³ " + (data?.error || "Too many requests. Wait a moment."));
            } else {
                updateRadioStatus(`âŒ ${data?.error || "Search failed"}`);
            }
            return;
        }

        if (data.items && data.items.length > 0) {
            songResultsData = data.items.map(item => ({
                id: item.id.videoId,
                trackName: item.snippet.title || "Untitled",
                artistName: item.snippet.channelTitle || "Unknown channel"
            }));
            renderYoutubeResults();
            updateRadioStatus(`Found ${songResultsData.length} tracks.`);
            playYoutubeTrack(0);
        } else {
            songResultsData = [];
            renderYoutubeResults();
            updateRadioStatus("No results found.");
        }
    } catch (err) {
        console.error(err);
        updateRadioStatus("âŒ Network error. Check connection.");
    }
}

function renderYoutubeResults() {
    songResults.innerHTML = "";
    
    if (songResultsData.length === 0) {
        const empty = document.createElement("div");
        empty.className = "song-item";
        const meta = document.createElement("div");
        meta.className = "song-meta";
        const t = document.createElement("div");
        t.className = "song-title";
        t.textContent = "No results";
        const a = document.createElement("div");
        a.className = "song-artist";
        a.textContent = "Try another keyword";
        meta.appendChild(t);
        meta.appendChild(a);
        empty.appendChild(meta);
        songResults.appendChild(empty);
        return;
    }

    songResultsData.forEach((track, index) => {
        const row = document.createElement("div");
        row.className = "song-item";
        const meta = document.createElement("div");
        meta.className = "song-meta";
        const title = document.createElement("div");
        title.className = "song-title";
        title.textContent = track.trackName;
        const artist = document.createElement("div");
        artist.className = "song-artist";
        artist.textContent = track.artistName;
        const button = document.createElement("button");
        button.className = "btn song-play";
        button.textContent = "PLAY";
        button.addEventListener("click", () => playYoutubeTrack(index));

        meta.appendChild(title);
        meta.appendChild(artist);
        row.appendChild(meta);
        row.appendChild(button);
        songResults.appendChild(row);
    });
}

function playYoutubeTrack(index) {
    const track = songResultsData[index];
    if (!track) return;
    
    radioName.textContent = track.trackName;
    updateRadioStatus("Now playing in the Guild Hall...");
    
    const embedUrl = `https://www.youtube.com/embed/${track.id}?autoplay=1&rel=0&playsinline=1`;
    document.getElementById("youtube-embed").src = embedUrl;
}

songSearchInput.addEventListener("keydown", e => {
    if (e.key === "Enter") searchYoutubeSongs();
});

// â”€â”€ LETTER â”€â”€
async function loadLetterFromFile() {
    const letterEl = document.getElementById("letter-text");
    if (!letterEl) return;

    const fallbackText = letterEl.textContent;
    const candidates = ["lucifer.txt", "From Lucifer.txt", "from-lucifer.txt", "letter.txt"];

    for (const fileName of candidates) {
        try {
            const res = await fetch(fileName, { cache: "no-store" });
            if (!res.ok) continue;
            const text = (await res.text()).trim();
            if (!text) continue;
            letterEl.dataset.fullText = text;
            letterEl.textContent = text;
            return;
        } catch (_) {}
    }

    letterEl.dataset.fullText = fallbackText;
}

function revealLetterSlowly() {
    const letterEl = document.getElementById("letter-text");
    if (!letterEl) return;

    const fullText = letterEl.dataset.fullText || letterEl.textContent || "";
    letterEl.dataset.fullText = fullText;
    letterEl.textContent = "";
    letterEl.classList.remove("is-revealing");
    void letterEl.offsetWidth;
    letterEl.classList.add("is-revealing");

    if (letterRevealTimer) clearTimeout(letterRevealTimer);

    let index = 0;
    const step = () => {
        index += 1;
        letterEl.textContent = fullText.slice(0, index);
        if (index < fullText.length) {
            letterRevealTimer = setTimeout(step, 22);
        }
    };
    step();
}

function openLetter() {
    document.getElementById("letter-overlay").classList.add("visible");
    revealLetterSlowly();
}
function closeLetter() {
    document.getElementById("letter-overlay").classList.remove("visible");
    if (letterRevealTimer) clearTimeout(letterRevealTimer);
}
</script>
</body>
</html>
